<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIDentity Monitoring Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/style.css">
    <script src="/static/script.js" defer></script>
    <style>
        .iframe-container {
            position: relative;
            overflow: hidden;
            width: 100%;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
        }
        .iframe-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            width: 100%;
            height: 100%;
            border: none;
        }
        .status-healthy {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <header class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-shield-alt text-blue-600 mr-2"></i>
                        DIDentity Monitoring Dashboard
                    </h1>
                    <p class="text-sm text-gray-600 mt-1">
                        Decentralized Identity Platform - Microservices Monitoring & Management
                    </p>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="auth-indicators">
                        <!-- Authentication status will be populated by JavaScript -->
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-gray-500">Auto-refresh in <span id="refresh-timer">30</span>s</div>
                        <div class="text-xs text-gray-500">
                            <i class="fas fa-database mr-1"></i>Vault Secured
                            <i class="fas fa-shield-check text-green-500 ml-1"></i>
                        </div>
                    </div>
                    <button onclick="location.reload()" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- Overview Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <!-- Services Status -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Services</p>
                        <p class="text-2xl font-bold">{{ healthy_services }}/{{ total_services }}</p>
                    </div>
                    <div class="text-3xl {% if healthy_services == total_services %}text-green-500{% else %}text-yellow-500{% endif %}">
                        <i class="fas fa-server"></i>
                    </div>
                </div>
            </div>

            <!-- Monitoring Tools Status -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Monitoring Tools</p>
                        <p class="text-2xl font-bold">{{ healthy_monitoring }}/{{ total_monitoring }}</p>
                    </div>
                    <div class="text-3xl {% if healthy_monitoring == total_monitoring %}text-green-500{% else %}text-yellow-500{% endif %}">
                        <i class="fas fa-chart-line"></i>
                    </div>
                </div>
            </div>

            <!-- System Status -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">System Status</p>
                        <p class="text-2xl font-bold">
                            {% if healthy_services == total_services and healthy_monitoring == total_monitoring %}
                                Healthy
                            {% elif healthy_services > 0 %}
                                Degraded
                            {% else %}
                                Critical
                            {% endif %}
                        </p>
                    </div>
                    <div class="text-3xl {% if healthy_services == total_services and healthy_monitoring == total_monitoring %}text-green-500{% elif healthy_services > 0 %}text-yellow-500{% else %}text-red-500{% endif %}">
                        <i class="fas fa-heartbeat"></i>
                    </div>
                </div>
            </div>

            <!-- Quick Links -->
            <div class="bg-white rounded-lg shadow p-6">
                <p class="text-gray-600 text-sm mb-2">DIDentity API Endpoints</p>
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <a href="http://localhost:8004/docs" target="_blank" rel="noopener" class="text-blue-600 hover:text-blue-800 flex items-center">
                        <i class="fas fa-user-shield mr-1"></i> Auth API
                    </a>
                    <a href="http://localhost:8001/docs" target="_blank" rel="noopener" class="text-purple-600 hover:text-purple-800 flex items-center">
                        <i class="fas fa-fingerprint mr-1"></i> DID API
                    </a>
                    <a href="http://localhost:8002/docs" target="_blank" rel="noopener" class="text-orange-600 hover:text-orange-800 flex items-center">
                        <i class="fas fa-certificate mr-1"></i> Credential API
                    </a>
                    <a href="http://localhost:8003/docs" target="_blank" rel="noopener" class="text-teal-600 hover:text-teal-800 flex items-center">
                        <i class="fas fa-shield-check mr-1"></i> Verify API
                    </a>
                </div>
                <div class="mt-3 pt-2 border-t border-gray-200">
                    <p class="text-gray-500 text-xs mb-1">Monitoring Tools</p>
                    <div class="grid grid-cols-2 gap-1 text-xs">
                        <a href="http://localhost:3000" target="_blank" rel="noopener" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-chart-bar mr-1"></i> Grafana
                        </a>
                        <a href="http://localhost:16686" target="_blank" rel="noopener" class="text-indigo-600 hover:text-indigo-800">
                            <i class="fas fa-project-diagram mr-1"></i> Jaeger
                        </a>
                        <a href="http://localhost:9090" target="_blank" rel="noopener" class="text-orange-600 hover:text-orange-800">
                            <i class="fas fa-database mr-1"></i> Prometheus
                        </a>
                        <a href="http://localhost:15672" target="_blank" rel="noopener" class="text-green-600 hover:text-green-800">
                            <i class="fas fa-envelope mr-1"></i> RabbitMQ
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Service Status Grid -->
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="p-4 border-b">
                <h2 class="text-lg font-semibold">
                    <i class="fas fa-server text-blue-600 mr-2"></i>
                    Service Health Status
                </h2>
            </div>
            <div class="p-4">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    {% for service in services %}
                    <div class="border rounded-lg p-4 {% if service.status == 'healthy' %}border-green-300 bg-green-50{% else %}border-red-300 bg-red-50{% endif %}">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-semibold">{{ service.name }}</h3>
                            <span class="{% if service.status == 'healthy' %}text-green-600 status-healthy{% else %}text-red-600{% endif %}">
                                <i class="fas fa-circle"></i>
                            </span>
                        </div>
                        <p class="text-sm text-gray-600">Port: {{ service.port }}</p>
                        <p class="text-sm {% if service.status == 'healthy' %}text-green-600{% else %}text-red-600{% endif %}">
                            Status: {{ service.status|title }}
                        </p>
                        {% if service.status == 'healthy' and service.details.database %}
                        <p class="text-xs text-gray-500 mt-1">Database: {{ service.details.database }}</p>
                        {% endif %}
                        
                        <!-- Service-specific functionality info -->
                        {% if service.name == 'Auth Service' %}
                        <div class="mt-2 p-2 bg-blue-50 rounded text-xs">
                            <p class="font-medium text-blue-800">Key Features:</p>
                            <ul class="text-blue-700 mt-1">
                                <li>• User Registration</li>
                                <li>• JWT Authentication</li>
                                <li>• Token Refresh</li>
                            </ul>
                        </div>
                        {% elif service.name == 'DID Service' %}
                        <div class="mt-2 p-2 bg-purple-50 rounded text-xs">
                            <p class="font-medium text-purple-800">Key Features:</p>
                            <ul class="text-purple-700 mt-1">
                                <li>• DID Creation</li>
                                <li>• DID Resolution</li>
                                <li>• Multiple Methods</li>
                            </ul>
                        </div>
                        {% elif service.name == 'Credential Service' %}
                        <div class="mt-2 p-2 bg-orange-50 rounded text-xs">
                            <p class="font-medium text-orange-800">Key Features:</p>
                            <ul class="text-orange-700 mt-1">
                                <li>• Credential Issuance</li>
                                <li>• Credential Management</li>
                                <li>• VC Standards</li>
                            </ul>
                        </div>
                        {% elif service.name == 'Verification Service' %}
                        <div class="mt-2 p-2 bg-teal-50 rounded text-xs">
                            <p class="font-medium text-teal-800">Key Features:</p>
                            <ul class="text-teal-700 mt-1">
                                <li>• Credential Verification</li>
                                <li>• Status Checking</li>
                                <li>• Trust Validation</li>
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- DIDentity Workflow Status -->
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="p-4 border-b">
                <h2 class="text-lg font-semibold">
                    <i class="fas fa-id-card text-blue-600 mr-2"></i>
                    DIDentity Workflow Status
                </h2>
            </div>
            <div class="p-4">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <!-- Step 1: User Registration -->
                    <div class="bg-blue-50 border border-blue-300 rounded p-4">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-user-plus text-blue-600 mr-2"></i>
                            <h3 class="font-semibold text-blue-800">1. User Registration</h3>
                        </div>
                        <p class="text-blue-700 text-sm">POST /signup</p>
                        <p class="text-blue-600 text-xs">Auth Service (Port: 8004)</p>
                        <div class="mt-2 flex items-center">
                            <span class="flex items-center text-xs">
                                <i class="fas fa-circle text-green-500 mr-1"></i>
                                Ready
                            </span>
                        </div>
                    </div>

                    <!-- Step 2: DID Creation -->
                    <div class="bg-purple-50 border border-purple-300 rounded p-4">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-fingerprint text-purple-600 mr-2"></i>
                            <h3 class="font-semibold text-purple-800">2. DID Creation</h3>
                        </div>
                        <p class="text-purple-700 text-sm">POST /dids</p>
                        <p class="text-purple-600 text-xs">DID Service (Port: 8001)</p>
                        <div class="mt-2 flex items-center">
                            <span class="flex items-center text-xs">
                                <i class="fas fa-circle text-green-500 mr-1"></i>
                                Ready
                            </span>
                        </div>
                    </div>

                    <!-- Step 3: Credential Issuance -->
                    <div class="bg-orange-50 border border-orange-300 rounded p-4">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-certificate text-orange-600 mr-2"></i>
                            <h3 class="font-semibold text-orange-800">3. Credential Issue</h3>
                        </div>
                        <p class="text-orange-700 text-sm">POST /credentials/issue</p>
                        <p class="text-orange-600 text-xs">Credential Service (Port: 8002)</p>
                        <div class="mt-2 flex items-center">
                            <span class="flex items-center text-xs">
                                <i class="fas fa-circle text-green-500 mr-1"></i>
                                Ready
                            </span>
                        </div>
                    </div>

                    <!-- Step 4: Verification -->
                    <div class="bg-teal-50 border border-teal-300 rounded p-4">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-shield-check text-teal-600 mr-2"></i>
                            <h3 class="font-semibold text-teal-800">4. Verification</h3>
                        </div>
                        <p class="text-teal-700 text-sm">POST /credentials/verify</p>
                        <p class="text-teal-600 text-xs">Verification Service (Port: 8003)</p>
                        <div class="mt-2 flex items-center">
                            <span class="flex items-center text-xs">
                                <i class="fas fa-circle text-green-500 mr-1"></i>
                                Ready
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Test Button -->
                <div class="mt-4 text-center">
                    <button onclick="runDemoWorkflow()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                        <i class="fas fa-play mr-2"></i>
                        Test Complete DIDentity Workflow
                    </button>
                    <div id="workflow-results" class="mt-4 hidden">
                        <!-- Results will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Monitoring Tools Tabs -->
        <div class="bg-white rounded-lg shadow">
            <div class="border-b">
                <div class="flex">
                    <button class="tab-button px-6 py-3 font-semibold border-b-2 border-transparent hover:text-blue-600 active" onclick="showTab('grafana')">
                        <i class="fas fa-chart-bar mr-2"></i>Grafana
                    </button>
                    <button class="tab-button px-6 py-3 font-semibold border-b-2 border-transparent hover:text-blue-600" onclick="showTab('prometheus')">
                        <i class="fas fa-database mr-2"></i>Prometheus
                    </button>
                    <button class="tab-button px-6 py-3 font-semibold border-b-2 border-transparent hover:text-blue-600" onclick="showTab('jaeger')">
                        <i class="fas fa-project-diagram mr-2"></i>Jaeger
                    </button>
                    <button class="tab-button px-6 py-3 font-semibold border-b-2 border-transparent hover:text-blue-600" onclick="showTab('rabbitmq')">
                        <i class="fas fa-envelope mr-2"></i>RabbitMQ
                    </button>
                    <button class="tab-button px-6 py-3 font-semibold border-b-2 border-transparent hover:text-blue-600" onclick="showTab('overview')">
                        <i class="fas fa-th mr-2"></i>Overview
                    </button>
                </div>
            </div>

            <!-- Tab Contents -->
            <div class="p-4">
                <!-- Grafana Tab -->
                <div id="grafana-tab" class="tab-content active">
                    {% for tool in monitoring_tools %}
                        {% if tool.name == 'Grafana' and tool.status == 'healthy' %}
                        <div class="mb-4">
                            <!-- Status and Info Section -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div class="bg-green-50 border border-green-300 rounded p-4">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-check-circle text-green-600 mr-2"></i>
                                        <h3 class="font-semibold text-green-800">Grafana Status</h3>
                                    </div>
                                    <p class="text-green-700 text-sm">Service is running and accessible</p>
                                    <p class="text-green-600 text-xs mt-1">Port: {{ tool.port }}</p>
                                </div>
                                
                                <div class="bg-blue-50 border border-blue-300 rounded p-4">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-chart-bar text-blue-600 mr-2"></i>
                                        <h3 class="font-semibold text-blue-800">Metrics Visualization</h3>
                                    </div>
                                    <p class="text-blue-700 text-sm">Displays DIDentity service metrics</p>
                                    <p class="text-blue-600 text-xs mt-1">System health and performance</p>
                                </div>

                                <div class="bg-purple-50 border border-purple-300 rounded p-4">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-tachometer-alt text-purple-600 mr-2"></i>
                                        <h3 class="font-semibold text-purple-800">Real-time Dashboards</h3>
                                    </div>
                                    <p class="text-purple-700 text-sm">Auth, DID, credential services</p>
                                    <p class="text-purple-600 text-xs mt-1">Database and API monitoring</p>
                                </div>
                            </div>

                            <!-- Embed Section -->
                            <div class="mb-4">
                                <div class="bg-blue-50 border border-blue-300 rounded p-3 mb-4">
                                    <p class="text-blue-800 text-sm">
                                        <i class="fas fa-info-circle mr-2"></i>
                                        Grafana dashboards showing DIDentity service metrics, database performance, and API response times with automatic fallback handling.
                                    </p>
                                </div>
                                
                                <div class="iframe-container mb-4" id="grafana-iframe-container">
                                    <iframe 
                                        src="{{ tool.embed_url }}" 
                                        allowfullscreen
                                        sandbox="allow-same-origin allow-scripts allow-forms"
                                        onload="handleGrafanaLoad()"
                                        onerror="handleGrafanaError()"
                                        style="width: 100%; height: 100%; border: none;">
                                    </iframe>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <a href="{{ tool.url }}" target="_blank" class="bg-blue-500 text-white px-4 py-3 rounded hover:bg-blue-600 text-center">
                                    <i class="fas fa-external-link-alt mr-2"></i>
                                    Open Full Interface
                                </a>
                                <button onclick="testGrafanaConnection()" class="bg-green-500 text-white px-4 py-3 rounded hover:bg-green-600">
                                    <i class="fas fa-network-wired mr-2"></i>
                                    Test Connection
                                </button>
                                <button onclick="retryGrafanaEmbed()" class="bg-purple-500 text-white px-4 py-3 rounded hover:bg-purple-600">
                                    <i class="fas fa-redo mr-2"></i>
                                    Retry Embed
                                </button>
                            </div>

                            <!-- Test Results -->
                            <div id="grafana-test-results" class="mt-4 hidden">
                                <!-- Results will be populated by JavaScript -->
                            </div>
                        </div>
                        {% elif tool.name == 'Grafana' %}
                        <div class="text-center py-12">
                            <i class="fas fa-exclamation-triangle text-6xl text-red-500 mb-4"></i>
                            <p class="text-xl text-gray-600 mb-4">Grafana is currently unavailable</p>
                            <div class="space-y-4">
                                <div class="bg-red-50 border border-red-300 rounded p-4 max-w-md mx-auto">
                                    <p class="text-red-700 text-sm mb-2">
                                        <i class="fas fa-times-circle mr-2"></i>
                                        Service Status: Unhealthy
                                    </p>
                                    <p class="text-red-600 text-xs">
                                        Expected Port: {{ tool.port }}
                                    </p>
                                </div>
                                
                                <div class="space-y-2">
                                    <p class="text-gray-500">Troubleshooting options:</p>
                                    <div class="flex justify-center space-x-4">
                                        <a href="http://localhost:3000" target="_blank" class="text-blue-600 hover:text-blue-800">
                                            <i class="fas fa-external-link-alt mr-1"></i>
                                            Try Direct Access
                                        </a>
                                        <button onclick="location.reload()" class="text-green-600 hover:text-green-800">
                                            <i class="fas fa-sync-alt mr-1"></i>
                                            Retry Connection
                                        </button>
                                        <button onclick="checkGrafanaLogs()" class="text-orange-600 hover:text-orange-800">
                                            <i class="fas fa-file-alt mr-1"></i>
                                            Check Logs
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>

                <!-- Prometheus Tab -->
                <div id="prometheus-tab" class="tab-content">
                    {% for tool in monitoring_tools %}
                        {% if tool.name == 'Prometheus' and tool.status == 'healthy' %}
                        <div class="mb-4">
                            <!-- Status and Info Section -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div class="bg-green-50 border border-green-300 rounded p-4">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-check-circle text-green-600 mr-2"></i>
                                        <h3 class="font-semibold text-green-800">Prometheus Status</h3>
                                    </div>
                                    <p class="text-green-700 text-sm">Service is running and accessible</p>
                                    <p class="text-green-600 text-xs mt-1">Port: {{ tool.port }}</p>
                                </div>
                                
                                <div class="bg-blue-50 border border-blue-300 rounded p-4">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-database text-blue-600 mr-2"></i>
                                        <h3 class="font-semibold text-blue-800">Metrics Collection</h3>
                                    </div>
                                    <p class="text-blue-700 text-sm">Time-series database</p>
                                    <p class="text-blue-600 text-xs mt-1">Query interface available</p>
                                </div>

                                <div class="bg-purple-50 border border-purple-300 rounded p-4">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-search text-purple-600 mr-2"></i>
                                        <h3 class="font-semibold text-purple-800">Query Features</h3>
                                    </div>
                                    <p class="text-purple-700 text-sm">PromQL query language</p>
                                    <p class="text-purple-600 text-xs mt-1">Real-time data exploration</p>
                                </div>
                            </div>

                            <!-- Embed Section -->
                            <div class="mb-4">
                                <div class="bg-blue-50 border border-blue-300 rounded p-3 mb-4">
                                    <p class="text-blue-800 text-sm">
                                        <i class="fas fa-info-circle mr-2"></i>
                                        Prometheus query interface for exploring metrics and creating custom queries.
                                    </p>
                                </div>
                                
                                <div class="iframe-container mb-4" id="prometheus-iframe-container">
                                    <iframe 
                                        src="{{ tool.embed_url }}" 
                                        allowfullscreen
                                        sandbox="allow-same-origin allow-scripts allow-forms"
                                        onload="handlePrometheusLoad()"
                                        onerror="handlePrometheusError()"
                                        style="width: 100%; height: 100%; border: none;">
                                    </iframe>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <a href="{{ tool.url }}" target="_blank" class="bg-orange-500 text-white px-4 py-3 rounded hover:bg-orange-600 text-center">
                                    <i class="fas fa-external-link-alt mr-2"></i>
                                    Open Full Interface
                                </a>
                                <button onclick="testPrometheusConnection()" class="bg-blue-500 text-white px-4 py-3 rounded hover:bg-blue-600">
                                    <i class="fas fa-network-wired mr-2"></i>
                                    Test Connection
                                </button>
                                <button onclick="retryPrometheusEmbed()" class="bg-green-500 text-white px-4 py-3 rounded hover:bg-green-600">
                                    <i class="fas fa-redo mr-2"></i>
                                    Retry Embed
                                </button>
                            </div>

                            <!-- Test Results -->
                            <div id="prometheus-test-results" class="mt-4 hidden">
                                <!-- Results will be populated by JavaScript -->
                            </div>
                        </div>
                        {% elif tool.name == 'Prometheus' %}
                        <div class="text-center py-12">
                            <i class="fas fa-exclamation-triangle text-6xl text-red-500 mb-4"></i>
                            <p class="text-xl text-gray-600 mb-4">Prometheus is currently unavailable</p>
                            <div class="space-y-4">
                                <div class="bg-red-50 border border-red-300 rounded p-4 max-w-md mx-auto">
                                    <p class="text-red-700 text-sm mb-2">
                                        <i class="fas fa-times-circle mr-2"></i>
                                        Service Status: Unhealthy
                                    </p>
                                    <p class="text-red-600 text-xs">
                                        Expected Port: {{ tool.port }}
                                    </p>
                                </div>
                                
                                <div class="space-y-2">
                                    <p class="text-gray-500">Troubleshooting options:</p>
                                    <div class="flex justify-center space-x-4">
                                        <a href="http://localhost:9090" target="_blank" class="text-blue-600 hover:text-blue-800">
                                            <i class="fas fa-external-link-alt mr-1"></i>
                                            Try Direct Access
                                        </a>
                                        <button onclick="location.reload()" class="text-green-600 hover:text-green-800">
                                            <i class="fas fa-sync-alt mr-1"></i>
                                            Retry Connection
                                        </button>
                                        <button onclick="checkPrometheusLogs()" class="text-orange-600 hover:text-orange-800">
                                            <i class="fas fa-file-alt mr-1"></i>
                                            Check Logs
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>

                <!-- Jaeger Tab -->
                <div id="jaeger-tab" class="tab-content">
                    {% for tool in monitoring_tools %}
                        {% if tool.name == 'Jaeger' and tool.status == 'healthy' %}
                        <div class="mb-4">
                            <!-- Status and Info Section -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div class="bg-green-50 border border-green-300 rounded p-4">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-check-circle text-green-600 mr-2"></i>
                                        <h3 class="font-semibold text-green-800">Jaeger Status</h3>
                                    </div>
                                    <p class="text-green-700 text-sm">Service is running and accessible</p>
                                    <p class="text-green-600 text-xs mt-1">Port: {{ tool.port }}</p>
                                </div>
                                
                                <div class="bg-blue-50 border border-blue-300 rounded p-4">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-project-diagram text-blue-600 mr-2"></i>
                                        <h3 class="font-semibold text-blue-800">Tracing Features</h3>
                                    </div>
                                    <p class="text-blue-700 text-sm">Distributed tracing system</p>
                                    <p class="text-blue-600 text-xs mt-1">Request flow visualization</p>
                                </div>

                                <div class="bg-purple-50 border border-purple-300 rounded p-4">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-route text-purple-600 mr-2"></i>
                                        <h3 class="font-semibold text-purple-800">Trace Analysis</h3>
                                    </div>
                                    <p class="text-purple-700 text-sm">Service dependency mapping</p>
                                    <p class="text-purple-600 text-xs mt-1">Performance bottleneck detection</p>
                                </div>
                            </div>

                            <!-- Embed Section -->
                            <div class="mb-4">
                                <div class="bg-blue-50 border border-blue-300 rounded p-3 mb-4">
                                    <p class="text-blue-800 text-sm">
                                        <i class="fas fa-info-circle mr-2"></i>
                                        Jaeger UI for searching and analyzing distributed traces across your services.
                                    </p>
                                </div>
                                
                                <div class="iframe-container mb-4" id="jaeger-iframe-container">
                                    <iframe 
                                        src="{{ tool.embed_url }}" 
                                        allowfullscreen
                                        sandbox="allow-same-origin allow-scripts allow-forms"
                                        onload="handleJaegerLoad()"
                                        onerror="handleJaegerError()"
                                        style="width: 100%; height: 100%; border: none;">
                                    </iframe>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <a href="{{ tool.url }}" target="_blank" class="bg-indigo-500 text-white px-4 py-3 rounded hover:bg-indigo-600 text-center">
                                    <i class="fas fa-external-link-alt mr-2"></i>
                                    Open Full Interface
                                </a>
                                <button onclick="testJaegerConnection()" class="bg-blue-500 text-white px-4 py-3 rounded hover:bg-blue-600">
                                    <i class="fas fa-network-wired mr-2"></i>
                                    Test Connection
                                </button>
                                <button onclick="retryJaegerEmbed()" class="bg-green-500 text-white px-4 py-3 rounded hover:bg-green-600">
                                    <i class="fas fa-redo mr-2"></i>
                                    Retry Embed
                                </button>
                            </div>

                            <!-- Test Results -->
                            <div id="jaeger-test-results" class="mt-4 hidden">
                                <!-- Results will be populated by JavaScript -->
                            </div>
                        </div>
                        {% elif tool.name == 'Jaeger' %}
                        <div class="text-center py-12">
                            <i class="fas fa-exclamation-triangle text-6xl text-red-500 mb-4"></i>
                            <p class="text-xl text-gray-600 mb-4">Jaeger is currently unavailable</p>
                            <div class="space-y-4">
                                <div class="bg-red-50 border border-red-300 rounded p-4 max-w-md mx-auto">
                                    <p class="text-red-700 text-sm mb-2">
                                        <i class="fas fa-times-circle mr-2"></i>
                                        Service Status: Unhealthy
                                    </p>
                                    <p class="text-red-600 text-xs">
                                        Expected Port: {{ tool.port }}
                                    </p>
                                </div>
                                
                                <div class="space-y-2">
                                    <p class="text-gray-500">Troubleshooting options:</p>
                                    <div class="flex justify-center space-x-4">
                                        <a href="http://localhost:16686" target="_blank" class="text-blue-600 hover:text-blue-800">
                                            <i class="fas fa-external-link-alt mr-1"></i>
                                            Try Direct Access
                                        </a>
                                        <button onclick="location.reload()" class="text-green-600 hover:text-green-800">
                                            <i class="fas fa-sync-alt mr-1"></i>
                                            Retry Connection
                                        </button>
                                        <button onclick="checkJaegerLogs()" class="text-orange-600 hover:text-orange-800">
                                            <i class="fas fa-file-alt mr-1"></i>
                                            Check Logs
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>

                <!-- RabbitMQ Tab -->
                <div id="rabbitmq-tab" class="tab-content">
                    {% for tool in monitoring_tools %}
                        {% if tool.name == 'RabbitMQ' and tool.status == 'healthy' %}
                        <div class="mb-4">
                            <!-- Status and Info Section -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div class="bg-green-50 border border-green-300 rounded p-4">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-check-circle text-green-600 mr-2"></i>
                                        <h3 class="font-semibold text-green-800">RabbitMQ Status</h3>
                                    </div>
                                    <p class="text-green-700 text-sm">Service is running and accessible</p>
                                    <p class="text-green-600 text-xs mt-1">Port: {{ tool.port }}</p>
                                    {% if tool.rabbitmq_info and tool.rabbitmq_info.version %}
                                    <p class="text-green-600 text-xs">Version: {{ tool.rabbitmq_info.version }}</p>
                                    {% endif %}
                                </div>
                                
                                <div class="bg-blue-50 border border-blue-300 rounded p-4">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-exchange-alt text-blue-600 mr-2"></i>
                                        <h3 class="font-semibold text-blue-800">Message Queuing</h3>
                                    </div>
                                    <p class="text-blue-700 text-sm">Inter-service communication</p>
                                    <p class="text-blue-600 text-xs mt-1">Async processing support</p>
                                </div>

                                {% if tool.rabbitmq_info and tool.rabbitmq_info.total_queues is defined %}
                                <div class="bg-purple-50 border border-purple-300 rounded p-4">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-list text-purple-600 mr-2"></i>
                                        <h3 class="font-semibold text-purple-800">Queue Statistics</h3>
                                    </div>
                                    <p class="text-purple-700 text-sm">Queues: {{ tool.rabbitmq_info.total_queues }}</p>
                                    <p class="text-purple-600 text-xs mt-1">Messages: {{ tool.rabbitmq_info.total_messages }}</p>
                                </div>
                                {% else %}
                                <div class="bg-purple-50 border border-purple-300 rounded p-4">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-cogs text-purple-600 mr-2"></i>
                                        <h3 class="font-semibold text-purple-800">DIDentity Queues</h3>
                                    </div>
                                    <p class="text-purple-700 text-sm">Credential processing</p>
                                    <p class="text-purple-600 text-xs mt-1">Verification workflows</p>
                                </div>
                                {% endif %}
                            </div>

                            <!-- Embed Attempt -->
                            <div class="mb-4">
                                <div class="bg-yellow-50 border border-yellow-300 rounded p-3 mb-4">
                                    <p class="text-yellow-800 text-sm">
                                        <i class="fas fa-exclamation-triangle mr-2"></i>
                                        RabbitMQ Management UI for monitoring DIDentity message queues and service communication. May not embed properly due to authentication requirements.
                                    </p>
                                </div>
                                
                                <div class="iframe-container mb-4" id="rabbitmq-iframe-container">
                                    <iframe 
                                        src="{{ tool.url }}" 
                                        allowfullscreen
                                        sandbox="allow-same-origin allow-scripts allow-forms allow-popups"
                                        onload="handleRabbitMQLoad()"
                                        onerror="handleRabbitMQError()"
                                        style="width: 100%; height: 100%; border: none;">
                                    </iframe>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <a href="{{ tool.url }}" target="_blank" class="bg-orange-500 text-white px-4 py-3 rounded hover:bg-orange-600 text-center">
                                    <i class="fas fa-external-link-alt mr-2"></i>
                                    Open Management UI
                                </a>
                                <button onclick="testRabbitMQConnection()" class="bg-blue-500 text-white px-4 py-3 rounded hover:bg-blue-600">
                                    <i class="fas fa-network-wired mr-2"></i>
                                    Test Connection
                                </button>
                                <button onclick="retryRabbitMQEmbed()" class="bg-green-500 text-white px-4 py-3 rounded hover:bg-green-600">
                                    <i class="fas fa-redo mr-2"></i>
                                    Retry Embed
                                </button>
                            </div>

                            <!-- Connection Test Results -->
                            <div id="rabbitmq-test-results" class="mt-4 hidden">
                                <!-- Results will be populated by JavaScript -->
                            </div>
                        </div>
                        {% elif tool.name == 'RabbitMQ' %}
                        <div class="text-center py-12">
                            <i class="fas fa-exclamation-triangle text-6xl text-red-500 mb-4"></i>
                            <p class="text-xl text-gray-600 mb-4">RabbitMQ is currently unavailable</p>
                            <div class="space-y-4">
                                <div class="bg-red-50 border border-red-300 rounded p-4 max-w-md mx-auto">
                                    <p class="text-red-700 text-sm mb-2">
                                        <i class="fas fa-times-circle mr-2"></i>
                                        Service Status: Unhealthy
                                    </p>
                                    <p class="text-red-600 text-xs">
                                        Expected Port: {{ tool.port }}
                                    </p>
                                </div>
                                
                                <div class="space-y-2">
                                    <p class="text-gray-500">Troubleshooting options:</p>
                                    <div class="flex justify-center space-x-4">
                                        <a href="http://localhost:15672" target="_blank" class="text-blue-600 hover:text-blue-800">
                                            <i class="fas fa-external-link-alt mr-1"></i>
                                            Try Direct Access
                                        </a>
                                        <button onclick="location.reload()" class="text-green-600 hover:text-green-800">
                                            <i class="fas fa-sync-alt mr-1"></i>
                                            Retry Connection
                                        </button>
                                        <button onclick="checkRabbitMQLogs()" class="text-orange-600 hover:text-orange-800">
                                            <i class="fas fa-file-alt mr-1"></i>
                                            Check Logs
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>

                <!-- Overview Tab -->
                <div id="overview-tab" class="tab-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {% for tool in monitoring_tools %}
                        <div class="border rounded-lg p-4 {% if tool.status == 'healthy' %}border-green-300 bg-green-50{% else %}border-red-300 bg-red-50{% endif %}">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-semibold">{{ tool.name }}</h3>
                                <span class="{% if tool.status == 'healthy' %}text-green-600{% else %}text-red-600{% endif %}">
                                    <i class="fas fa-circle"></i>
                                </span>
                            </div>
                            <p class="text-sm text-gray-600 mb-3">Port: {{ tool.port }}</p>
                            <a href="{{ tool.url }}" target="_blank" class="text-blue-600 hover:text-blue-800">
                                <i class="fas fa-external-link-alt mr-1"></i>
                                Open {{ tool.name }}
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Grafana embed URLs - primary and fallbacks
        const grafanaBaseUrl = 'http://localhost:3000';
        const grafanaEmbedUrls = [
            '{{ monitoring_tools|selectattr("name", "equalto", "Grafana")|first|attr("embed_url") if monitoring_tools|selectattr("name", "equalto", "Grafana")|first else "" }}',
            grafanaBaseUrl + '/d/did-services-overview/did-services-overview?orgId=1&refresh=5s&kiosk',
            grafanaBaseUrl + '/d/did-services-overview/did-services-overview?orgId=1&kiosk=tv',
            grafanaBaseUrl + '/d/did-services-overview/did-services-overview?orgId=1'
        ];
        
        let grafanaEmbedAttempts = 0;

        // Tab switching
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Mark button as active
            event.target.classList.add('active');
        }

        // Grafana iframe handling with multiple URL attempts
        function handleGrafanaLoad() {
            console.log('Grafana iframe loaded successfully');
            const errorMsg = document.getElementById('grafana-error-msg');
            if (errorMsg) {
                errorMsg.style.display = 'none';
            }
        }

        function handleGrafanaError() {
            console.log('Grafana iframe failed to load, attempt:', grafanaEmbedAttempts + 1);
            tryNextGrafanaUrl();
        }

        function tryNextGrafanaUrl() {
            grafanaEmbedAttempts++;
            
            if (grafanaEmbedAttempts < grafanaEmbedUrls.length) {
                const nextUrl = grafanaEmbedUrls[grafanaEmbedAttempts];
                console.log('Trying Grafana URL:', nextUrl);
                
                const container = document.getElementById('grafana-iframe-container');
                if (container) {
                    container.innerHTML = '<div class="text-center py-4 bg-blue-50 border border-blue-300 rounded mb-2"><p class="text-blue-800 text-sm"><i class="fas fa-spinner fa-spin mr-2"></i>Trying alternative embed URL (' + (grafanaEmbedAttempts + 1) + '/' + grafanaEmbedUrls.length + ')...</p></div><iframe src="' + nextUrl + '" allowfullscreen sandbox="allow-same-origin allow-scripts allow-forms" onload="handleGrafanaLoad()" onerror="handleGrafanaError()" style="width: 100%; height: 100%; border: none;"></iframe>';
                }
            } else {
                showGrafanaError();
            }
        }

        function showGrafanaError() {
            const container = document.getElementById('grafana-iframe-container');
            if (container) {
                container.innerHTML = '<div class="text-center py-12 bg-yellow-50 border border-yellow-300 rounded" id="grafana-error-msg"><i class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-4"></i><p class="text-lg text-gray-700 mb-2">Unable to embed Grafana dashboard</p><p class="text-sm text-gray-600 mb-4">Tried ' + grafanaEmbedAttempts + ' different embed URLs. This is likely due to iframe restrictions or CORS policies.</p><div class="space-y-2"><button onclick="retryGrafanaEmbed()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mr-2"><i class="fas fa-redo mr-1"></i> Retry All URLs</button><button onclick="openGrafanaDirectly()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600"><i class="fas fa-external-link-alt mr-1"></i> Open Grafana Directly</button></div></div>';
            }
        }

        function retryGrafanaEmbed() {
            grafanaEmbedAttempts = 0;
            const container = document.getElementById('grafana-iframe-container');
            if (container && grafanaEmbedUrls.length > 0) {
                const firstUrl = grafanaEmbedUrls[0];
                container.innerHTML = '<iframe src="' + firstUrl + '" allowfullscreen sandbox="allow-same-origin allow-scripts allow-forms" onload="handleGrafanaLoad()" onerror="handleGrafanaError()" style="width: 100%; height: 100%; border: none;"></iframe>';
            }
        }

        function openGrafanaDirectly() {
            window.open('http://localhost:3000', '_blank');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Grafana embed URLs available:', grafanaEmbedUrls);
            
            setTimeout(() => {
                const grafanaIframe = document.querySelector('#grafana-iframe-container iframe');
                if (grafanaIframe) {
                    try {
                        grafanaIframe.onload = function() {
                            try {
                                const iframeDoc = grafanaIframe.contentDocument || grafanaIframe.contentWindow.document;
                                if (!iframeDoc || iframeDoc.body.innerHTML === '') {
                                    setTimeout(() => {
                                        if (grafanaEmbedAttempts === 0) {
                                            handleGrafanaError();
                                        }
                                    }, 3000);
                                }
                            } catch (e) {
                                console.log('Grafana iframe blocked by CORS policy');
                                setTimeout(() => {
                                    if (grafanaEmbedAttempts === 0) {
                                        handleGrafanaError();
                                    }
                                }, 2000);
                            }
                        };
                    } catch (e) {
                        console.log('Error setting up iframe monitoring:', e);
                    }
                }
            }, 1000);
        });

        // Auto-refresh timer
        let refreshTimer = 30;
        setInterval(() => {
            refreshTimer--;
            document.getElementById('refresh-timer').textContent = refreshTimer;
            if (refreshTimer <= 0) {
                location.reload();
            }
        }, 1000);

        // Auto-refresh every 30 seconds
        setTimeout(() => {
            location.reload();
        }, 30000);

        // ===== GRAFANA FUNCTIONS =====
        function testGrafanaConnection() {
            const resultsDiv = document.getElementById('grafana-test-results');
            if (resultsDiv) {
                resultsDiv.classList.remove('hidden');
                resultsDiv.innerHTML = '<div class="bg-blue-50 border border-blue-300 rounded p-4"><div class="flex items-center"><i class="fas fa-spinner fa-spin text-blue-600 mr-2"></i><p class="text-blue-800">Testing Grafana connection...</p></div></div>';
                
                // Use our backend to test Grafana instead of direct browser request
                fetch('/api/monitoring/health')
                    .then(response => response.json())
                    .then(data => {
                        const grafanaStatus = data.find(tool => tool.name === 'Grafana');
                        if (grafanaStatus && grafanaStatus.status === 'healthy') {
                            resultsDiv.innerHTML = `
                                <div class="bg-green-50 border border-green-300 rounded p-4">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-check-circle text-green-600 mr-2"></i>
                                        <h4 class="font-semibold text-green-800">Grafana Connection Test Successful</h4>
                                    </div>
                                    <p class="text-green-700 text-sm">Grafana is accessible and responding to requests.</p>
                                    <p class="text-green-600 text-xs mt-1">Port: ${grafanaStatus.port}</p>
                                    <div class="mt-3 flex space-x-2">
                                        <a href="${grafanaStatus.url}" target="_blank" class="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700">
                                            <i class="fas fa-external-link-alt mr-1"></i> Open Grafana
                                        </a>
                                        <a href="${grafanaStatus.url}/d/did-services-overview/did-services-overview?orgId=1" target="_blank" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700">
                                            <i class="fas fa-chart-line mr-1"></i> View Dashboard
                                        </a>
                                    </div>
                                </div>
                            `;
                        } else {
                            throw new Error(grafanaStatus?.error || 'Service unavailable');
                        }
                    })
                    .catch(error => {
                        resultsDiv.innerHTML = `
                            <div class="bg-yellow-50 border border-yellow-300 rounded p-4">
                                <div class="flex items-center mb-2">
                                    <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                                    <h4 class="font-semibold text-yellow-800">Grafana Connection Test Failed</h4>
                                </div>
                                <p class="text-yellow-700 text-sm">Error: ${error.message}</p>
                                <div class="mt-3 p-2 bg-yellow-100 rounded text-xs">
                                    <p class="font-medium">Troubleshooting suggestions:</p>
                                    <ul class="mt-1 space-y-1">
                                        <li>• Check if Grafana container is running: <code>docker-compose ps grafana</code></li>
                                        <li>• Verify Grafana logs: <code>docker-compose logs grafana</code></li>
                                        <li>• Ensure port 3000 is accessible</li>
                                        <li>• Check Docker network connectivity</li>
                                    </ul>
                                </div>
                                <div class="mt-3 flex space-x-2">
                                    <button onclick="testGrafanaConnection()" class="bg-yellow-600 text-white px-3 py-1 rounded text-xs hover:bg-yellow-700">
                                        <i class="fas fa-redo mr-1"></i> Retry Test
                                    </button>
                                    <a href="http://localhost:3000" target="_blank" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700">
                                        <i class="fas fa-external-link-alt mr-1"></i> Try Direct Access
                                    </a>
                                </div>
                            </div>
                        `;
                    });
            }
        }

        function checkGrafanaLogs() {
            alert('To check Grafana logs, run: docker-compose logs grafana');
        }

        // ===== PROMETHEUS FUNCTIONS =====
        function handlePrometheusLoad() {
            console.log('Prometheus iframe loaded successfully');
        }

        function handlePrometheusError() {
            console.log('Prometheus iframe failed to load');
            showPrometheusError();
        }

        function showPrometheusError() {
            const container = document.getElementById('prometheus-iframe-container');
            if (container) {
                container.innerHTML = '<div class="text-center py-12 bg-red-50 border border-red-300 rounded"><i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i><p class="text-lg text-gray-700 mb-2">Unable to embed Prometheus interface</p><p class="text-sm text-gray-600 mb-4">This may be due to iframe restrictions or connectivity issues.</p><div class="space-y-2"><button onclick="retryPrometheusEmbed()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mr-2"><i class="fas fa-redo mr-1"></i> Retry Embed</button><button onclick="openPrometheusDirectly()" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600"><i class="fas fa-external-link-alt mr-1"></i> Open Directly</button></div></div>';
            }
        }

        function retryPrometheusEmbed() {
            const container = document.getElementById('prometheus-iframe-container');
            if (container) {
                container.innerHTML = '<iframe src="http://localhost:9090/graph" allowfullscreen sandbox="allow-same-origin allow-scripts allow-forms" onload="handlePrometheusLoad()" onerror="handlePrometheusError()" style="width: 100%; height: 100%; border: none;"></iframe>';
            }
        }

        function openPrometheusDirectly() {
            window.open('http://localhost:9090', '_blank');
        }

        function testPrometheusConnection() {
            const resultsDiv = document.getElementById('prometheus-test-results');
            if (resultsDiv) {
                resultsDiv.classList.remove('hidden');
                resultsDiv.innerHTML = '<div class="bg-blue-50 border border-blue-300 rounded p-4"><div class="flex items-center"><i class="fas fa-spinner fa-spin text-blue-600 mr-2"></i><p class="text-blue-800">Testing Prometheus connection...</p></div></div>';
                
                // Use our backend to test Prometheus instead of direct browser request
                fetch('/api/monitoring/health')
                    .then(response => response.json())
                    .then(data => {
                        const prometheusStatus = data.find(tool => tool.name === 'Prometheus');
                        if (prometheusStatus && prometheusStatus.status === 'healthy') {
                            resultsDiv.innerHTML = `
                                <div class="bg-green-50 border border-green-300 rounded p-4">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-check-circle text-green-600 mr-2"></i>
                                        <h4 class="font-semibold text-green-800">Prometheus Connection Test Successful</h4>
                                    </div>
                                    <p class="text-green-700 text-sm">Prometheus is accessible and collecting metrics.</p>
                                    <p class="text-green-600 text-xs mt-1">Port: ${prometheusStatus.port}</p>
                                    <div class="mt-3 flex space-x-2">
                                        <a href="${prometheusStatus.url}" target="_blank" class="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700">
                                            <i class="fas fa-external-link-alt mr-1"></i> Open Prometheus
                                        </a>
                                        <a href="${prometheusStatus.url}/targets" target="_blank" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700">
                                            <i class="fas fa-bullseye mr-1"></i> View Targets
                                        </a>
                                    </div>
                                </div>
                            `;
                        } else {
                            throw new Error(prometheusStatus?.error || 'Service unavailable');
                        }
                    })
                    .catch(error => {
                        resultsDiv.innerHTML = `
                            <div class="bg-yellow-50 border border-yellow-300 rounded p-4">
                                <div class="flex items-center mb-2">
                                    <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                                    <h4 class="font-semibold text-yellow-800">Prometheus Connection Test Failed</h4>
                                </div>
                                <div class="text-yellow-700 text-sm space-y-2">
                                    <p><strong>Error:</strong> ${error.message}</p>
                                    <div class="mt-3 p-2 bg-yellow-100 rounded text-xs">
                                        <p class="font-medium">Troubleshooting tips:</p>
                                        <ul class="mt-1 space-y-1">
                                            <li>• Check if Prometheus container is running: <code>docker-compose ps prometheus</code></li>
                                            <li>• Verify Prometheus logs: <code>docker-compose logs prometheus</code></li>
                                            <li>• Ensure port 9090 is accessible</li>
                                            <li>• Check Docker network connectivity</li>
                                            <li>• Verify Prometheus configuration</li>
                                        </ul>
                                    </div>
                                    <div class="mt-3 flex space-x-2">
                                        <button onclick="testPrometheusConnection()" class="bg-yellow-600 text-white px-3 py-1 rounded text-xs hover:bg-yellow-700">
                                            <i class="fas fa-redo mr-1"></i> Retry Test
                                        </button>
                                        <a href="http://localhost:9090" target="_blank" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700">
                                            <i class="fas fa-external-link-alt mr-1"></i> Try Direct Access
                                        </a>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
            }
        }

        function checkPrometheusLogs() {
            alert('To check Prometheus logs, run: docker-compose logs prometheus');
        }

        // ===== JAEGER FUNCTIONS =====
        function handleJaegerLoad() {
            console.log('Jaeger iframe loaded successfully');
        }

        function handleJaegerError() {
            console.log('Jaeger iframe failed to load');
            showJaegerError();
        }

        function showJaegerError() {
            const container = document.getElementById('jaeger-iframe-container');
            if (container) {
                container.innerHTML = '<div class="text-center py-12 bg-red-50 border border-red-300 rounded"><i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i><p class="text-lg text-gray-700 mb-2">Unable to embed Jaeger interface</p><p class="text-sm text-gray-600 mb-4">This may be due to iframe restrictions or connectivity issues.</p><div class="space-y-2"><button onclick="retryJaegerEmbed()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mr-2"><i class="fas fa-redo mr-1"></i> Retry Embed</button><button onclick="openJaegerDirectly()" class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600"><i class="fas fa-external-link-alt mr-1"></i> Open Directly</button></div></div>';
            }
        }

        function retryJaegerEmbed() {
            const container = document.getElementById('jaeger-iframe-container');
            if (container) {
                container.innerHTML = '<iframe src="http://localhost:16686/search?service=auth-service" allowfullscreen sandbox="allow-same-origin allow-scripts allow-forms" onload="handleJaegerLoad()" onerror="handleJaegerError()" style="width: 100%; height: 100%; border: none;"></iframe>';
            }
        }

        function openJaegerDirectly() {
            window.open('http://localhost:16686', '_blank');
        }

        function testJaegerConnection() {
            const resultsDiv = document.getElementById('jaeger-test-results');
            if (resultsDiv) {
                resultsDiv.classList.remove('hidden');
                resultsDiv.innerHTML = '<div class="bg-blue-50 border border-blue-300 rounded p-4"><div class="flex items-center"><i class="fas fa-spinner fa-spin text-blue-600 mr-2"></i><p class="text-blue-800">Testing Jaeger connection...</p></div></div>';
                
                // Use our backend to test Jaeger instead of direct browser request
                fetch('/api/monitoring/health')
                    .then(response => response.json())
                    .then(data => {
                        const jaegerStatus = data.find(tool => tool.name === 'Jaeger');
                        if (jaegerStatus && jaegerStatus.status === 'healthy') {
                            resultsDiv.innerHTML = `
                                <div class="bg-green-50 border border-green-300 rounded p-4">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-check-circle text-green-600 mr-2"></i>
                                        <h4 class="font-semibold text-green-800">Jaeger Connection Test Successful</h4>
                                    </div>
                                    <p class="text-green-700 text-sm">Jaeger is accessible and collecting traces.</p>
                                    <p class="text-green-600 text-xs mt-1">Port: ${jaegerStatus.port}</p>
                                    <div class="mt-3 flex space-x-2">
                                        <a href="${jaegerStatus.url}" target="_blank" class="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700">
                                            <i class="fas fa-external-link-alt mr-1"></i> Open Jaeger
                                        </a>
                                        <a href="${jaegerStatus.url}/search" target="_blank" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700">
                                            <i class="fas fa-search mr-1"></i> Search Traces
                                        </a>
                                    </div>
                                </div>
                            `;
                        } else {
                            throw new Error(jaegerStatus?.error || 'Service unavailable');
                        }
                    })
                    .catch(error => {
                        resultsDiv.innerHTML = `
                            <div class="bg-yellow-50 border border-yellow-300 rounded p-4">
                                <div class="flex items-center mb-2">
                                    <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                                    <h4 class="font-semibold text-yellow-800">Jaeger Connection Test Failed</h4>
                                </div>
                                <div class="text-yellow-700 text-sm space-y-2">
                                    <p><strong>Error:</strong> ${error.message}</p>
                                    <div class="mt-3 p-2 bg-yellow-100 rounded text-xs">
                                        <p class="font-medium">Troubleshooting tips:</p>
                                        <ul class="mt-1 space-y-1">
                                            <li>• Check if Jaeger container is running: <code>docker-compose ps jaeger</code></li>
                                            <li>• Verify Jaeger logs: <code>docker-compose logs jaeger</code></li>
                                            <li>• Ensure port 16686 is accessible</li>
                                            <li>• Check Docker network connectivity</li>
                                            <li>• Verify Jaeger is properly configured</li>
                                        </ul>
                                    </div>
                                    <div class="mt-3 flex space-x-2">
                                        <button onclick="testJaegerConnection()" class="bg-yellow-600 text-white px-3 py-1 rounded text-xs hover:bg-yellow-700">
                                            <i class="fas fa-redo mr-1"></i> Retry Test
                                        </button>
                                        <a href="http://localhost:16686" target="_blank" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700">
                                            <i class="fas fa-external-link-alt mr-1"></i> Try Direct Access
                                        </a>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
            }
        }

        function checkJaegerLogs() {
            alert('To check Jaeger logs, run: docker-compose logs jaeger');
        }

        // ===== RABBITMQ FUNCTIONS (keeping existing) =====
        function handleRabbitMQLoad() {
            console.log('RabbitMQ iframe loaded successfully');
            // Check if it's actually the login page or management interface
            setTimeout(() => {
                try {
                    const iframe = document.querySelector('#rabbitmq-iframe-container iframe');
                    if (iframe) {
                        // Try to detect if we're on the login page
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        if (iframeDoc && iframeDoc.title && iframeDoc.title.includes('RabbitMQ')) {
                            showRabbitMQLoginInfo();
                        }
                    }
                } catch (e) {
                    // CORS will prevent access, but that's expected
                    console.log('RabbitMQ iframe loaded (CORS protected)');
                }
            }, 2000);
        }

        function handleRabbitMQError() {
            console.log('RabbitMQ iframe failed to load');
            showRabbitMQError();
        }

        function showRabbitMQLoginInfo() {
            const container = document.getElementById('rabbitmq-iframe-container');
            if (container) {
                // Add a floating login reminder
                const loginReminder = document.createElement('div');
                loginReminder.className = 'absolute top-2 right-2 bg-blue-500 text-white px-3 py-2 rounded shadow-lg z-10';
                loginReminder.innerHTML = '<i class="fas fa-key mr-2"></i>Login: guest/guest';
                loginReminder.style.position = 'absolute';
                loginReminder.style.zIndex = '1000';
                container.style.position = 'relative';
                container.appendChild(loginReminder);
                
                // Remove the reminder after 10 seconds
                setTimeout(() => {
                    if (loginReminder.parentNode) {
                        loginReminder.parentNode.removeChild(loginReminder);
                    }
                }, 10000);
            }
        }

        function showRabbitMQError() {
            const container = document.getElementById('rabbitmq-iframe-container');
            if (container) {
                container.innerHTML = '<div class="text-center py-12 bg-red-50 border border-red-300 rounded"><i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i><p class="text-lg text-gray-700 mb-2">Unable to embed RabbitMQ Management UI</p><p class="text-sm text-gray-600 mb-4">This is likely due to authentication requirements or iframe restrictions.</p><div class="space-y-2"><button onclick="retryRabbitMQEmbed()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mr-2"><i class="fas fa-redo mr-1"></i> Retry Embed</button><button onclick="openRabbitMQDirectly()" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600"><i class="fas fa-external-link-alt mr-1"></i> Open Directly</button></div></div>';
            }
        }

        function retryRabbitMQEmbed() {
            const container = document.getElementById('rabbitmq-iframe-container');
            if (container) {
                container.innerHTML = '<iframe src="http://localhost:15672" allowfullscreen sandbox="allow-same-origin allow-scripts allow-forms allow-popups" onload="handleRabbitMQLoad()" onerror="handleRabbitMQError()" style="width: 100%; height: 100%; border: none;"></iframe>';
            }
        }

        function openRabbitMQDirectly() {
            window.open('http://localhost:15672', '_blank');
        }

        function testRabbitMQConnection() {
            const resultsDiv = document.getElementById('rabbitmq-test-results');
            if (resultsDiv) {
                resultsDiv.classList.remove('hidden');
                resultsDiv.innerHTML = '<div class="bg-blue-50 border border-blue-300 rounded p-4"><div class="flex items-center"><i class="fas fa-spinner fa-spin text-blue-600 mr-2"></i><p class="text-blue-800">Testing RabbitMQ connection and fetching statistics...</p></div></div>';
                
                // Test detailed RabbitMQ statistics
                fetch('/api/rabbitmq/stats')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        const contentType = response.headers.get('content-type');
                        if (!contentType || !contentType.includes('application/json')) {
                            throw new Error(`Expected JSON response, got ${contentType || 'unknown content type'}`);
                        }
                        
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === 'healthy') {
                            resultsDiv.innerHTML = `
                                <div class="bg-green-50 border border-green-300 rounded p-4">
                                    <div class="flex items-center mb-3">
                                        <i class="fas fa-check-circle text-green-600 mr-2"></i>
                                        <h4 class="font-semibold text-green-800">RabbitMQ Connection Test Successful</h4>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                        <div class="bg-white rounded p-3 border border-green-200">
                                            <h5 class="font-medium text-green-800 mb-2">System Information</h5>
                                            <div class="text-green-700 text-sm space-y-1">
                                                <p><i class="fas fa-server mr-2"></i>Version: ${data.overview.rabbitmq_version || 'Unknown'}</p>
                                                <p><i class="fas fa-code mr-2"></i>Erlang: ${data.overview.erlang_version || 'Unknown'}</p>
                                                <p><i class="fas fa-network-wired mr-2"></i>Node: ${data.overview.node || 'Unknown'}</p>
                                                <p><i class="fas fa-clock mr-2"></i>Uptime: ${Math.floor((data.overview.uptime || 0) / 1000)} seconds</p>
                                            </div>
                                        </div>
                                        
                                        <div class="bg-white rounded p-3 border border-green-200">
                                            <h5 class="font-medium text-green-800 mb-2">Statistics</h5>
                                            <div class="text-green-700 text-sm space-y-1">
                                                <p><i class="fas fa-list mr-2"></i>Queues: ${data.statistics.total_queues}</p>
                                                <p><i class="fas fa-exchange-alt mr-2"></i>Exchanges: ${data.statistics.total_exchanges}</p>
                                                <p><i class="fas fa-plug mr-2"></i>Connections: ${data.statistics.total_connections}</p>
                                                <p><i class="fas fa-envelope mr-2"></i>Total Messages: ${data.statistics.total_messages}</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    ${data.queues && data.queues.length > 0 ? `
                                        <div class="bg-white rounded p-3 border border-green-200">
                                            <h5 class="font-medium text-green-800 mb-2">Recent Queues</h5>
                                            <div class="overflow-x-auto">
                                                <table class="min-w-full text-sm">
                                                    <thead>
                                                        <tr class="border-b border-green-200">
                                                            <th class="text-left py-1 px-2 text-green-800">Queue</th>
                                                            <th class="text-left py-1 px-2 text-green-800">Messages</th>
                                                            <th class="text-left py-1 px-2 text-green-800">Ready</th>
                                                            <th class="text-left py-1 px-2 text-green-800">Consumers</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${data.queues.map(queue => `
                                                            <tr class="border-b border-green-100">
                                                                <td class="py-1 px-2 text-green-700">${queue.name}</td>
                                                                <td class="py-1 px-2 text-green-700">${queue.messages}</td>
                                                                <td class="py-1 px-2 text-green-700">${queue.messages_ready}</td>
                                                                <td class="py-1 px-2 text-green-700">${queue.consumers}</td>
                                                            </tr>
                                                        `).join('')}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        } else {
                            // Handle API error responses
                            resultsDiv.innerHTML = `
                                <div class="bg-red-50 border border-red-300 rounded p-4">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-times-circle text-red-600 mr-2"></i>
                                        <h4 class="font-semibold text-red-800">RabbitMQ Connection Test Failed</h4>
                                    </div>
                                    <div class="text-red-700 text-sm space-y-1">
                                        <p><i class="fas fa-exclamation-triangle mr-2"></i>${data.error || 'Unknown error occurred'}</p>
                                        ${data.status_code ? `<p class="text-red-600 text-xs">Status Code: ${data.status_code}</p>` : ''}
                                        <div class="mt-3 p-2 bg-red-100 rounded text-xs">
                                            <p class="font-medium">Troubleshooting tips:</p>
                                            <ul class="mt-1 space-y-1">
                                                <li>• Check if RabbitMQ service is running: <code>docker-compose ps rabbitmq</code></li>
                                                <li>• Verify RabbitMQ logs: <code>docker-compose logs rabbitmq</code></li>
                                                <li>• Ensure management plugin is enabled</li>
                                                <li>• Try accessing directly: <a href="http://localhost:15672" target="_blank" class="text-blue-600 underline">http://localhost:15672</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    })
                    .catch(error => {
                        console.error('RabbitMQ test error:', error);
                        
                        let errorMessage = error.message;
                        let troubleshootingTips = [];
                        
                        if (errorMessage.includes('Unexpected token')) {
                            errorMessage = 'Received HTML instead of JSON - likely an authentication redirect or error page';
                            troubleshootingTips = [
                                'RabbitMQ Management UI may not be properly configured',
                                'Check if guest user is enabled and has management permissions',
                                'Verify RabbitMQ management plugin is installed and enabled',
                                'Try accessing the management UI directly to verify it works'
                            ];
                        } else if (errorMessage.includes('Failed to fetch') || errorMessage.includes('NetworkError')) {
                            errorMessage = 'Network connection failed - RabbitMQ may be down';
                            troubleshootingTips = [
                                'Check if RabbitMQ container is running',
                                'Verify port 15672 is accessible',
                                'Check Docker network connectivity',
                                'Review RabbitMQ container logs'
                            ];
                        } else if (errorMessage.includes('HTTP 401')) {
                            errorMessage = 'Authentication failed - invalid credentials';
                            troubleshootingTips = [
                                'Default credentials should be guest/guest',
                                'Check if guest user is enabled in RabbitMQ',
                                'Verify management plugin permissions',
                                'Check RabbitMQ user configuration'
                            ];
                        } else if (errorMessage.includes('HTTP 404')) {
                            errorMessage = 'RabbitMQ Management API not found';
                            troubleshootingTips = [
                                'Management plugin may not be enabled',
                                'Check RabbitMQ configuration',
                                'Verify correct port (15672) is being used',
                                'Ensure RabbitMQ is running with management plugin'
                            ];
                        }
                        
                        resultsDiv.innerHTML = `
                            <div class="bg-yellow-50 border border-yellow-300 rounded p-4">
                                <div class="flex items-center mb-2">
                                    <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                                    <h4 class="font-semibold text-yellow-800">Connection Test Failed</h4>
                                </div>
                                <div class="text-yellow-700 text-sm space-y-2">
                                    <p><strong>Error:</strong> ${errorMessage}</p>
                                    ${troubleshootingTips.length > 0 ? `
                                        <div class="mt-3 p-2 bg-yellow-100 rounded text-xs">
                                            <p class="font-medium">Troubleshooting tips:</p>
                                            <ul class="mt-1 space-y-1">
                                                ${troubleshootingTips.map(tip => `<li>• ${tip}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    <div class="mt-3 flex space-x-2">
                                        <button onclick="testRabbitMQConnection()" class="bg-yellow-600 text-white px-3 py-1 rounded text-xs hover:bg-yellow-700">
                                            <i class="fas fa-redo mr-1"></i> Retry Test
                                        </button>
                                        <a href="http://localhost:15672" target="_blank" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700">
                                            <i class="fas fa-external-link-alt mr-1"></i> Open RabbitMQ
                                        </a>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
            }
        }

        function checkRabbitMQLogs() {
            alert('To check RabbitMQ logs, run: docker-compose logs rabbitmq');
        }

        // ===== DIDIENTITY WORKFLOW TESTING =====
        function runDemoWorkflow() {
            const resultsDiv = document.getElementById('workflow-results');
            if (resultsDiv) {
                resultsDiv.classList.remove('hidden');
                resultsDiv.innerHTML = `
                    <div class="bg-blue-50 border border-blue-300 rounded p-4">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center">
                                <i class="fas fa-play text-blue-600 mr-2"></i>
                                <h4 class="font-semibold text-blue-800">DIDentity End-to-End Workflow Test</h4>
                            </div>
                            <div class="text-xs text-blue-600">
                                <span id="workflow-timer">Starting...</span>
                            </div>
                        </div>
                        <div class="space-y-3 text-sm">
                            <div id="step-1" class="flex items-center justify-between p-3 bg-white rounded border">
                                <div class="flex items-center">
                                    <i class="fas fa-circle text-gray-400 mr-3"></i>
                                    <div>
                                        <div class="font-medium">Step 1: User Registration</div>
                                        <div class="text-xs text-gray-500">Creating test user account...</div>
                                    </div>
                                </div>
                                <div class="text-xs text-gray-400" id="step-1-time">Waiting...</div>
                            </div>
                            <div id="step-2" class="flex items-center justify-between p-3 bg-white rounded border opacity-50">
                                <div class="flex items-center">
                                    <i class="fas fa-circle text-gray-400 mr-3"></i>
                                    <div>
                                        <div class="font-medium">Step 2: DID Creation</div>
                                        <div class="text-xs text-gray-500">Generating decentralized identifier...</div>
                                    </div>
                                </div>
                                <div class="text-xs text-gray-400" id="step-2-time">Waiting...</div>
                            </div>
                            <div id="step-3" class="flex items-center justify-between p-3 bg-white rounded border opacity-50">
                                <div class="flex items-center">
                                    <i class="fas fa-circle text-gray-400 mr-3"></i>
                                    <div>
                                        <div class="font-medium">Step 3: Credential Issuance</div>
                                        <div class="text-xs text-gray-500">Issuing verifiable credential...</div>
                                    </div>
                                </div>
                                <div class="text-xs text-gray-400" id="step-3-time">Waiting...</div>
                            </div>
                            <div id="step-4" class="flex items-center justify-between p-3 bg-white rounded border opacity-50">
                                <div class="flex items-center">
                                    <i class="fas fa-circle text-gray-400 mr-3"></i>
                                    <div>
                                        <div class="font-medium">Step 4: Credential Verification</div>
                                        <div class="text-xs text-gray-500">Verifying credential authenticity...</div>
                                    </div>
                                </div>
                                <div class="text-xs text-gray-400" id="step-4-time">Waiting...</div>
                            </div>
                        </div>
                        <div class="mt-4 text-center">
                            <button onclick="cancelWorkflow()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 text-sm">
                                <i class="fas fa-stop mr-1"></i> Cancel Test
                            </button>
                        </div>
                    </div>
                `;
                
                // Start the workflow with timing
                performSequentialWorkflowTest();
            }
        }

        let workflowStartTime;
        let workflowCancelled = false;

        function cancelWorkflow() {
            workflowCancelled = true;
            const resultsDiv = document.getElementById('workflow-results');
            if (resultsDiv) {
                resultsDiv.innerHTML = `
                    <div class="bg-yellow-50 border border-yellow-300 rounded p-4">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                            <h4 class="font-semibold text-yellow-800">Workflow Test Cancelled</h4>
                        </div>
                        <p class="text-yellow-700 text-sm">The workflow test was cancelled by user request.</p>
                        <div class="mt-3 text-center">
                            <button onclick="runDemoWorkflow()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                                <i class="fas fa-play mr-1"></i> Start New Test
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        async function performSequentialWorkflowTest() {
            workflowStartTime = Date.now();
            workflowCancelled = false;
            
            // Update timer every second
            const timerInterval = setInterval(() => {
                if (workflowCancelled) {
                    clearInterval(timerInterval);
                    return;
                }
                const elapsed = Math.floor((Date.now() - workflowStartTime) / 1000);
                const timerElement = document.getElementById('workflow-timer');
                if (timerElement) {
                    timerElement.textContent = `Elapsed: ${elapsed}s`;
                }
            }, 1000);

            try {
                // Try to use the backend API first for better error handling
                const backendResponse = await fetch('/api/test/workflow', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (backendResponse.ok) {
                    const data = await backendResponse.json();
                    if (data.status === 'success') {
                        // Process results sequentially with delays for better UX
                        for (let i = 0; i < data.results.steps.length; i++) {
                            if (workflowCancelled) return;
                            
                            const step = data.results.steps[i];
                            await updateWorkflowStepSequential(step.step, 'running');
                            
                            // Add realistic delay to show progression
                            await new Promise(resolve => setTimeout(resolve, 800 + Math.random() * 400));
                            
                            if (workflowCancelled) return;
                            await updateWorkflowStepSequential(step.step, step.status, step.message);
                            
                            // Brief pause between steps
                            await new Promise(resolve => setTimeout(resolve, 300));
                        }
                        
                        if (!workflowCancelled) {
                            clearInterval(timerInterval);
                            showSequentialWorkflowSuccess({
                                user: data.results.user,
                                did: data.results.did || 'Generated',
                                credential: data.results.credential || 'Issued',
                                verification: data.results.verification || 'valid',
                                totalTime: Math.floor((Date.now() - workflowStartTime) / 1000)
                            });
                        }
                        return;
                    } else {
                        throw new Error(data.message || 'Backend workflow test failed');
                    }
                } else {
                    throw new Error(`Backend API returned ${backendResponse.status}`);
                }
            } catch (backendError) {
                console.log('Backend API test failed, falling back to direct calls:', backendError);
                // Fall back to direct API calls with sequential processing
                await performDirectSequentialWorkflow();
            }
            
            clearInterval(timerInterval);
        }

        async function performDirectSequentialWorkflow() {
            const timestamp = Date.now();
            const testUser = {
                username: `testuser_${timestamp}`,
                email: `test_${timestamp}@example.com`,
                password: 'TestAuthentication123!'
            };

            try {
                // Step 1: User Registration
                if (workflowCancelled) return;
                await updateWorkflowStepSequential(1, 'running', 'Creating test user account...');
                
                const authResponse = await fetch('http://localhost:8004/signup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testUser)
                });
                
                if (!authResponse.ok) throw new Error(`Auth failed: ${authResponse.status}`);
                const authData = await authResponse.json();
                const token = authData.access_token;
                
                if (workflowCancelled) return;
                await updateWorkflowStepSequential(1, 'success', `User created: ${testUser.username}`);
                await new Promise(resolve => setTimeout(resolve, 500));

                // Step 2: DID Creation
                if (workflowCancelled) return;
                await updateWorkflowStepSequential(2, 'running', 'Generating DID with Base58 identifier...');
                
                // Generate valid Base58 identifier
                const base58_chars = "123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";
                const identifier = Array.from({length: 16}, () => base58_chars[Math.floor(Math.random() * base58_chars.length)]).join('');
                
                const didResponse = await fetch('http://localhost:8001/dids', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        method: 'key',
                        identifier: identifier
                    })
                });
                
                if (!didResponse.ok) throw new Error(`DID creation failed: ${didResponse.status}`);
                const didData = await didResponse.json();
                const did = didData.id;
                
                if (workflowCancelled) return;
                await updateWorkflowStepSequential(2, 'success', `DID created: ${did}`);
                await new Promise(resolve => setTimeout(resolve, 500));

                // Step 3: Credential Issuance
                if (workflowCancelled) return;
                await updateWorkflowStepSequential(3, 'running', 'Issuing verifiable credential...');
                
                const credentialResponse = await fetch('http://localhost:8002/credentials/issue', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        holder_did: did,
                        credential_data: {
                            name: 'Test User',
                            degree: 'Bachelor of Science',
                            institution: 'DIDentity University',
                            graduation_year: 2024
                        }
                    })
                });
                
                if (!credentialResponse.ok) throw new Error(`Credential issuance failed: ${credentialResponse.status}`);
                const credentialData = await credentialResponse.json();
                const credentialId = credentialData.credential_id;
                
                if (workflowCancelled) return;
                await updateWorkflowStepSequential(3, 'success', `Credential issued: ${credentialId}`);
                await new Promise(resolve => setTimeout(resolve, 500));

                // Step 4: Credential Verification
                if (workflowCancelled) return;
                await updateWorkflowStepSequential(4, 'running', 'Verifying credential authenticity...');
                
                const verificationResponse = await fetch('http://localhost:8003/credentials/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        credential_id: credentialId
                    })
                });
                
                if (!verificationResponse.ok) throw new Error(`Verification failed: ${verificationResponse.status}`);
                const verificationData = await verificationResponse.json();
                
                if (workflowCancelled) return;
                await updateWorkflowStepSequential(4, 'success', 'Credential verified successfully');

                // Show success summary
                if (!workflowCancelled) {
                    showSequentialWorkflowSuccess({
                        user: testUser.username,
                        did: did,
                        credential: credentialId,
                        verification: verificationData.status,
                        totalTime: Math.floor((Date.now() - workflowStartTime) / 1000)
                    });
                }

            } catch (error) {
                console.error('Workflow test failed:', error);
                if (!workflowCancelled) {
                    showSequentialWorkflowError(error.message);
                }
            }
        }

        async function updateWorkflowStepSequential(stepNumber, status, message = null) {
            const stepElement = document.getElementById(`step-${stepNumber}`);
            const timeElement = document.getElementById(`step-${stepNumber}-time`);
            
            if (!stepElement) return;
            
            // Remove opacity from current step
            stepElement.classList.remove('opacity-50');
            
            const icon = stepElement.querySelector('i');
            const messageDiv = stepElement.querySelector('.text-xs.text-gray-500');
            
            if (status === 'running') {
                icon.className = 'fas fa-spinner fa-spin text-blue-600 mr-3';
                stepElement.className = 'flex items-center justify-between p-3 bg-blue-50 rounded border border-blue-300';
                if (message) messageDiv.textContent = message;
                if (timeElement) timeElement.textContent = 'Running...';
                
                // Add pulsing animation
                stepElement.style.animation = 'pulse 2s infinite';
            } else if (status === 'success') {
                icon.className = 'fas fa-check-circle text-green-600 mr-3';
                stepElement.className = 'flex items-center justify-between p-3 bg-green-50 rounded border border-green-300';
                if (message) messageDiv.textContent = message;
                if (timeElement) {
                    const elapsed = Math.floor((Date.now() - workflowStartTime) / 1000);
                    timeElement.textContent = `${elapsed}s`;
                    timeElement.className = 'text-xs text-green-600 font-medium';
                }
                
                // Remove animation
                stepElement.style.animation = '';
                
                // Add success animation
                stepElement.style.transform = 'scale(1.02)';
                setTimeout(() => {
                    stepElement.style.transform = 'scale(1)';
                    stepElement.style.transition = 'transform 0.2s ease';
                }, 200);
                
            } else if (status === 'error') {
                icon.className = 'fas fa-times-circle text-red-600 mr-3';
                stepElement.className = 'flex items-center justify-between p-3 bg-red-50 rounded border border-red-300';
                if (message) messageDiv.textContent = message;
                if (timeElement) {
                    timeElement.textContent = 'Failed';
                    timeElement.className = 'text-xs text-red-600';
                }
                
                // Remove animation
                stepElement.style.animation = '';
            }
        }

        function showSequentialWorkflowSuccess(results) {
            const resultsDiv = document.getElementById('workflow-results');
            if (resultsDiv) {
                resultsDiv.innerHTML = `
                    <div class="bg-green-50 border border-green-300 rounded p-4">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-600 mr-2"></i>
                                <h4 class="font-semibold text-green-800">DIDentity Workflow Test - SUCCESS! 🎉</h4>
                            </div>
                            <div class="text-xs text-green-600 font-medium">
                                Completed in ${results.totalTime}s
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mb-4">
                            <div class="bg-white rounded p-3 border border-green-200">
                                <h5 class="font-medium text-green-800 mb-2">Test Results</h5>
                                <div class="space-y-1 text-green-700">
                                    <p><i class="fas fa-user mr-2"></i><strong>User:</strong> ${results.user}</p>
                                    <p><i class="fas fa-fingerprint mr-2"></i><strong>DID:</strong> <span class="font-mono text-xs">${results.did}</span></p>
                                    <p><i class="fas fa-certificate mr-2"></i><strong>Credential:</strong> <span class="font-mono text-xs">${results.credential}</span></p>
                                    <p><i class="fas fa-shield-check mr-2"></i><strong>Verification:</strong> ${results.verification}</p>
                                </div>
                            </div>
                            <div class="bg-white rounded p-3 border border-green-200">
                                <h5 class="font-medium text-green-800 mb-2">System Status</h5>
                                <div class="space-y-1 text-green-700">
                                    <p><i class="fas fa-check mr-2"></i>All services operational</p>
                                    <p><i class="fas fa-check mr-2"></i>End-to-end flow working</p>
                                    <p><i class="fas fa-check mr-2"></i>Database connectivity good</p>
                                    <p><i class="fas fa-check mr-2"></i>API endpoints responsive</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-green-100 rounded p-3 mb-4">
                            <h5 class="font-medium text-green-800 mb-2">Workflow Summary</h5>
                            <div class="text-xs text-green-700 space-y-1">
                                <p>✅ <strong>User Registration:</strong> Created test user with JWT authentication</p>
                                <p>✅ <strong>DID Creation:</strong> Generated decentralized identifier using key method</p>
                                <p>✅ <strong>Credential Issuance:</strong> Issued verifiable credential for test user</p>
                                <p>✅ <strong>Credential Verification:</strong> Successfully verified credential authenticity</p>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <button onclick="runDemoWorkflow()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 mr-2">
                                <i class="fas fa-redo mr-1"></i> Run Test Again
                            </button>
                            <button onclick="document.getElementById('workflow-results').classList.add('hidden')" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                                <i class="fas fa-times mr-1"></i> Close
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        function showSequentialWorkflowError(errorMessage) {
            const resultsDiv = document.getElementById('workflow-results');
            if (resultsDiv) {
                resultsDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-300 rounded p-4">
                        <div class="flex items-center mb-3">
                            <i class="fas fa-times-circle text-red-600 mr-2"></i>
                            <h4 class="font-semibold text-red-800">Workflow Test Failed</h4>
                        </div>
                        <div class="text-red-700 text-sm space-y-2">
                            <p><strong>Error:</strong> ${errorMessage}</p>
                            <div class="mt-3 p-2 bg-red-100 rounded text-xs">
                                <p class="font-medium">Troubleshooting suggestions:</p>
                                <ul class="mt-1 space-y-1">
                                    <li>• Check if all DIDentity services are running</li>
                                    <li>• Verify database connectivity</li>
                                    <li>• Ensure ports 8001-8004 are accessible</li>
                                    <li>• Check service logs for errors</li>
                                    <li>• Verify Vault is providing secrets correctly</li>
                                </ul>
                            </div>
                            <div class="mt-3 text-center">
                                <button onclick="runDemoWorkflow()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 mr-2">
                                    <i class="fas fa-redo mr-1"></i> Retry Test
                                </button>
                                <button onclick="document.getElementById('workflow-results').classList.add('hidden')" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                                    <i class="fas fa-times mr-1"></i> Close
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>